# План реалізації: Адміністрування дієт та локалізація (uk/en)

## 1) Дані та моделі
- Ролі: Admin, SuperAdmin (доступ до адміністрування).
- Моделі:
  - `Diet` / `DietTemplate` (день/тиждень): теги/категорії (збалансований, high-protein, low-carb, low-calorie).
  - `Product`: теги (алергени, категорії), одиниці виміру (г/мл; для en — унції/склянки), замінники, обмеження.
  - `DietRulesConfig`: пороги/формули БЖУ, адаптація під активність/HR/сон (конфіг).
  - `ProductSubstitution`, `ProductRestriction` (для раціонів/груп користувачів).
- Міграції БД: додати поля/таблиці (DietTemplate, DietTag, ProductSubstitution, ProductRestriction, порогові налаштування).

## 2) Локалізація
- Ресурси uk/en для усіх текстів API/рекомендацій.
- Локаль у профілі користувача; API повертає тексти за локаллю.
- Конвертер одиниць (г/мл ↔ унції/склянки) за локаллю.
- Глосарій термінів дієт/продуктів для uk/en.

## 3) API та права доступу
### Ролі та доступ (факт)
**Admin (контент, тільки читання на системне)**
- Продукти/рецепти: GET (`api/admin/products`, `api/admin/recipes`, включно details).
- Плани дієт: GET (список, by id, details, meals) у `DailyDietPlansController`.
- Система: GET `api/admin/overview`.
- Користувачі/девайси (admin-блок): тільки читання (списки/деталі).

**SuperAdmin (повний запис, системні CRUD)**
- Продукти/рецепти: POST/PUT/DELETE (`api/admin/products`, `api/admin/recipes`); GET теж доступний.
- Плани дієт (системні CRUD): POST/PUT/DELETE/create/generate/regenerate/check-corrections/apply-correction — тільки SuperAdmin; GET доступний Admin/SuperAdmin.
- Система: GET `api/admin/overview`.
- Загальне правило: усі системні CRUD/генерації/корекції — лише SuperAdmin; Admin має тільки читання.

### Локалізація (глибокий рівень, SuperAdmin)
- Ресурси uk/en для текстів рекомендацій/повідомлень: перегляд, оновлення, перевірка повноти перекладів.
- Одиниці виміру: керування мапінгом metric ↔ imperial, правила конвертації (г/мл ↔ унції/склянки).
- Глосарій/терміни для дієт і продуктів (uk/en), оновлення через адмінку.
- Фіча-флаги локалізації: вмикання/вимикання мов, тестові прев’ю для UI/API.
- Валідація локалізованих відповідей: smoke-check (наявність ключових ресурсів), опційно — експорт/імпорт ресурсів (dev).



- CRUD дієт/раціонів/шаблонів
  - DTO/контролер для створення/оновлення/видалення дієт і денних/тижневих шаблонів.
  - Прив’язка тегів/категорій; статус (published/archived).
  - Валідація нутрієнтів, доступність для сегментів користувачів.
- CRUD продуктів, нутрієнтів, тегів/категорій
  - DTO/контролер для продуктів: назва, нутрієнти, юніти (metric/imperial), теги/алергени.
  - Категорії/теги — окремі довідники або флаги; списки для селекторів.
- Управління замінниками/обмеженнями продуктів
  - Моделі Substitution/Restriction: productId, allowed/replacement productIds, notes.
  - Ендпоінти додати/оновити/видалити замінник чи обмеження.
- Контент: заборонені продукти/дієти, сезонні/нові продукти
  - Таблиця banned_lists per user group/segment; CRUD; ефект на фільтрацію генератора.
  - Поле seasonality/isNew у продуктів; ендпоінти масового оновлення.
- Diagnostics/Explain (читання)
  - Read-only ендпоінт: причини вибору раціону, застосовані правила/теги, розподіл калорій/макро.

#### SuperAdmin — додатково до Admin
- Управління правилами/порогами генерації/корекції
  - CRUD конфігів БЖУ-пропорцій, порогів активності/HR/сну; версіонування; активація конфігів.
  - Валідація значень (мін/макс), прев’ю впливу на розрахунок.
- Глобальні конфіги локалізації (переклади, юніти)
  - Ресурси uk/en для повідомлень/рекомендацій; ендпоінт оновлення ресурсів.
  - Налаштування юнітів (metric/imperial) за локаллю; маппінг для UI/API.
- Управління користувачами
  - Ендпоінти: блокування/розблокування (isActive), редагування профілю (адмін-override за запитом).
  - Логування адмін-змін профілю.
- Керування ролями
  - CRUD ролей; призначення/відкликання ролей (admin/superadmin) користувачам.
  - Захист від самознищення (superadmin не може зняти останню superadmin роль з себе).
- Перегляд системної аналітики
  - Read-only дашборд/ендпоінти: активність користувачів, використання шаблонів, контекстні показники.
  - Фільтри по даті/сегменту, експорт (csv/json).
- Доступ до audit/logs
  - Логи адмін-дій (хто/коли/що змінив), фільтр за сутністю/користувачем/датою.

### Блоки ендпоінтів (логічно)
1) Diets/Templates (Admin+):
   - CRUD дієт/шаблонів (день/тиждень), прив’язка тегів/категорій.
   - Публікація/архівація шаблонів.
   - Прегляди/прив’язка до сегментів користувачів.
2) Products (Admin+):
   - CRUD продуктів, нутрієнтів, одиниць виміру (г/мл; en — унції/склянки).
   - Теги (алергени/категорії), замінники, обмеження, сезонність.
3) Content/Restrictions (Admin+):
   - Заборонені продукти/дієти для груп користувачів.
   - Списки рекомендованих/анти-рекомендованих страв.
4) Rules/Thresholds (SuperAdmin):
   - БЖУ-пропорції, пороги активності/HR/сну, формули адаптації.
   - Увімк/вимк правил, версіонування конфігів.
5) Localization (SuperAdmin):
   - Ресурси uk/en для текстів рекомендацій/повідомлень.
   - Налаштування юнітів для локалі (metric/imperial).
6) Diagnostics/Explain (Admin+ read):
   - Отримати причини вибору раціону, лог розподілу калорій/макро.
   - Протокол останніх генерацій/корекцій (тільки читання).

## 4) Інтеграція з генерацією/корекцією
- MealPlanGenerator/DietCorrection читають адмінські правила:
  - БЖУ-пропорції, пороги активності/HR/сну.
  - Шаблони (день/тиждень) як стартові, далі фільтри/баланс.
- Локалізовані тексти рекомендацій, конверсія одиниць у відповідях.
- Explain: які теги/пороги/правила спрацювали.

## 5) Локалізований UI-вихід (через API)
- Повернення локалізованих підказок/назв юнітів (г/мл vs унції/склянки).
- Зміна мови профілю → тексти, юніти, терміни адаптуються.

## 6) Тестування
- Юніт:
  - Застосування правил/порогів у генерації/корекції.
  - Локалізація текстів та конвертація одиниць за локаллю.
  - Авторизація ролей Admin/SuperAdmin.
- Інтеграція/API:
  - CRUD дієт/шаблонів/продуктів/правил з перевіркою ролей.
  - Генерація/корекція з урахуванням адмін-настроювань і локалі.
  - Explain/diagnostics повертають коректні причини.
- Контент:
  - Заборонені продукти/дієти по групах.
  - Сезонні/нові продукти впливають на вибір.

## 7) Порядок впровадження
1. Моделі/міграції (теги, шаблони, замінники, пороги).
2. Локалізація (ресурси uk/en, конвертер одиниць).
3. Ролі/авторизація для адмін-API.
4. CRUD для дієт/шаблонів/продуктів/правил.
5. Інтеграція правил у генерацію/корекцію + локалізовані тексти.
6. Explain/diagnostics.
7. Тести (юнит/інтеграція) та чек-листи локалізації/ролей.

