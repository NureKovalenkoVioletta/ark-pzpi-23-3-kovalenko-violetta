# Звіт: MF-2. Формування персонального харчового плану

## Призначення
Автоматичне створення денного раціону користувача з урахуванням профілю, цілей, дієтарних обмежень, медичних станів, алергенів, історії рецептів, а також розподілу калорій/макро за прийомами їжі.

## Вхідні дані
- **Профіль користувача**: вік, стать, вага, зріст, активність (ActivityLevel), ціль (GoalType), дієтарні обмеження (DietaryRestrictionType), медичні стани (MedicalConditions), алергени, PreferredUnits, Locale.
- **Продукти/рецепти**: калорійність, макроси, теги `ProductTags` (Meat, Fish, Dairy, Egg, Honey, Gluten, PlantMilk, Alcohol, Pork, Shellfish, Peanut, TreeNut, Soy, Sesame, Legume, HighSodium, HighGI, HighProtein, Potassium, Phosphorus, Sugar, тощо).
- **Налаштування/константи**: ліміти повторів рецепта (`MAX_RECIPE_USAGE_PER_DAY = 1`), відсотки розподілу калорій за прийомами, толеранси макросів.

## Алгоритми та логіка
1) **Розрахунок калорій і макро**  
   - BMR (Mifflin-St Jeor), TDEE (множник активності), цільові калорії по GoalType (набір/підтримка/схуднення).  
   - Розподіл макросів: білки/жири/вуглеводи на день (пропорції в `MacroNutrientsCalculator`).  
   - Розподіл калорій за прийомами (`DistributeCaloriesByMealTime`) — фіксовані відсотки, перевірка суми.  
   - `BalanceMacrosForMeals` — пропорційне масштабування макросів по прийомах, консистентність суми з денними таргетами.

2) **Фільтрація продуктів і рецептів**  
   - Основний механізм: теги `ProductTags` (детермінований, без мовних ключових слів).  
   - Дієтарні обмеження: Vegan/Vegetarian/Pescatarian/GlutenFree/LactoseFree/Halal/Kosher → виключення за тегами.  
   - Медичні стани: Diabetes (HighGI/Sugar), Hypertension (HighSodium), KidneyDisease (HighProtein/Potassium/Phosphorus), CeliacDisease (Gluten), LactoseIntolerance (Dairy) тощо.  
   - Алергени: виключення за тегами (Peanut, TreeNut, Soy, Sesame тощо) та передані алергени.  
   - `includeAdvisory=false` дозволяє послабити advisory-фільтри (для деяких станів).  
   - Ключові слова залишені як fallback тільки там, де необхідно (Halal/Kosher), але основний шлях — теги.

3) **Генерація плану (`MealPlanGeneratorService`)**  
   - Вибір рецептів із урахуванням: дозволені продукти (після фільтра), виключення нещодавніх рецептів, толеранси по калоріях/макро, ліміт повтору рецепта `MAX_RECIPE_USAGE_PER_DAY = 1`.  
   - `SelectRecipesForMeal` сортує рецепти за близькістю до цільових калорій/макро прийому, перевіряє використання рецепта, добирає best-fit, fallback з урахуванням ліміту повторів.  
   - При створенні денного плану зберігаються Meals і MealRecipes, `PortionsMetadata` розраховується для потрібних порцій (base на калорії рецепта).

4) **Розподіл і баланс макро для прийомів**  
   - Після розподілу калорій по прийомах макроси масштабується пропорційно (`BalanceMacrosForMeals`).  
   - Перевірка суми макросів/калорій на відхилення; при необхідності корекція в межах толерансів.

5) **Ліміти повторів та різноманітність**  
   - В межах дня рецепт не може повторюватися більше 1 разу (рахунок в `recipeUsageCount`).  
   - Розширений seed-продуктів/рецептів під різні обмеження (vegan, gluten-free, lactose-free, med-кондішени) для кращої різноманітності.

## Використані сервери/компоненти
- **Сервіси**:  
  - `MealPlanGeneratorService` — основна генерація.  
  - `ProductFilterHelper` — фільтрація продуктів/рецептів за тегами/алергенами/обмеженнями.  
  - `CalorieCalculator`, `MacroNutrientsCalculator` — цільові калорії/макроси.  
  - `MedicalRestrictionsParser/Mapper` — парсинг і маппінг медичних обмежень (fallback-логіка).  
- **Контролер**:  
  - `DailyDietPlansController` — `POST /api/dailydietplans/generate` (створення плану), `GET` (деталі), `regenerate` (створення нового на дату).

## Математика / формули (узагальнено)
- **BMR (Mifflin-St Jeor)**:  
  - Ч ♂: `10*вага + 6.25*зріст - 5*вік + 5`  
  - Ж ♀: `10*вага + 6.25*зріст - 5*вік - 161`
- **TDEE**: `BMR * коеф. активності`  
- **GoalType**:  
  - Набір: `TDEE + надбавка`  
  - Підтримка: `TDEE`  
  - Схуднення: `TDEE - дефіцит`
- **Макро**: пропорції за замовчуванням (білок/жир/вуглеводи), білок мінімально з ваги, жир — відсоток калорій, вуглеводи — залишок.  
- **Розподіл калорій по прийомах**: фіксовані відсотки (сніданок/обід/вечеря/перекуси), сума = 100%.  
- **Перевірка толерансів**: вибір рецептів, чия калорійність/макро в межах допустимого відхилення від таргету прийому.

## Локалізація
- Повідомлення про помилки/валидацію в контролері — через `IStringLocalizer<SharedResources>`.  
- Locale береться з профілю/claim, middleware `UseRequestLocalization` (uk-UA/en-US).

## Персистенція
- Денний план (`DailyDietPlan`), прийоми (`Meal`), рецепти в прийомі (`MealRecipe`), `PortionsMetadata` перераховується під цільові калорії прийому.
- Флаг `IsCorrected` (для MF-3) — зберігається в плані.

## Юніт-тести (основні покриті кейси)
- Calorie/Macro calculators: BMR, TDEE, GoalType, розподіл макро.
- ProductFilterHelper: дієти, медичні стани, алергени, includeAdvisory, українські ключові слова (fallback).
- MedicalRestrictionsParser/Mapper: JSON/CSV, некоректний JSON (fallback).
- MealPlanGenerator: розподіл калорій, баланс макро, фільтри, виключення недавніх рецептів, толеранси, ліміт повторів, створення Meal/MealRecipe з PortionsMetadata.

## Потік даних (спрощено)
1) Завантажуємо профіль користувача (цілі, обмеження, алергени, історія рецептів).  
2) Розрахунок денних калорій/макро → розподіл по прийомах.  
3) Фільтрація продуктів/рецептів за тегами/обмеженнями.  
4) Вибір рецептів для кожного прийому (best-fit, ліміт повторів).  
5) Збереження плану, прийомів, рецептур і `PortionsMetadata`.  
6) Повернення детального плану через API (локалізовані повідомлення про помилки).

